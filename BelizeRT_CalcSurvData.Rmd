---
title: "Calcification and Survival Data Analyses and Visualization *(Castillo et al In Prep)*"
author: "Colleen B Bove"
date: "*Last run on `r format(Sys.time(), '%d %B %Y')`*"
output:
  html_document: 
    toc: true
    toc_float: true
    theme: flatly
---

<br/>

This file contains all data manipulations, analyses, and visualizations used to produce the calcification and survival results in Castillo et al (*In Prep*). All gene expression data and analyses can be found on Sarah Davies' GitHub at <span style="color: red;">*(GitHub link goes here)*</span>.


```{r load packages, message=FALSE, warning=FALSE, include=FALSE}

library(lme4)
library(cowplot)
library(kableExtra)
library(tidyverse)
library(survival)
library(coxme)
library(survival)
library(survminer)
library(finalfit)
library(performance)
library(gghalves)
library(xts)
library(FSA)
library(png)


## Knit standards
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, options(knitr.kable.NA = ''))
options(warn = -1)

```

```{r set some standards, message=FALSE, warning=FALSE, include=FALSE}

## this function removes rows with any missing values:
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}


## Set some values for running bootstrapping of calcification models:
bootnum = 4000 # set number of iterations (we used 4000) between 999 and 9999
seed = 14 # seed to make results replicatable (our seed was 14)

```


---



## *In situ* temperature {.tabset}

```{r temp dataframe setup, message=FALSE, warning=FALSE}

temp_long <- read.csv("Data/RTE_Temperature_Nov2014_Oct2015.csv") %>% 
  mutate(date_time = as.POSIXct(Date.Time, format = "%m/%d/%y %H:%M")) %>% # convert date/time to POSIXct class 
  select(-Date.Time) %>% 
  pivot_longer(Forereef:Nearshore, names_to = "reef", values_to = "temp") %>% 
  mutate(reef = fct_relevel(reef, c("Nearshore", "Backreef", "Forereef"))) 

temp_wide <- read.csv("Data/RTE_Temperature_Nov2014_Oct2015.csv") %>% 
  mutate(date_time = as.POSIXct(Date.Time, format = "%m/%d/%y %H:%M")) %>% # convert date/time to POSIXct class 
  select(-Date.Time) %>% 
  drop_na()

```

```{r all temperature measurements across time}

raw_temp_plot <- ggplot(data = temp_long, aes(x = date_time, y = temp, colour = reef, group = reef)) +
  geom_line() +
  scale_colour_manual(values = c("#D55E00","#009E73","#0072B2")) +
  theme_bw() +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = c(0.8, 0.2)) +
  ylab("Temperature (°C)")
raw_temp_plot

```

### Overall temperatures

Mean +/- SE and distribution across reefs
```{r overall temp plot}

temp_plot <- ggplot(data = temp_long, aes(x = reef, y = temp, fill = reef, colour = reef, group = reef)) +
  geom_half_violin(side = "r") +
  stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1), geom = "errorbar", width = 0, size = 1, colour = "gray15") +
  stat_summary(fun = "mean", size = 0.5, colour = "gray15") +
  scale_fill_manual(values = c("#D55E00","#009E73","#0072B2")) +
  scale_colour_manual(values = c("#D55E00","#009E73","#0072B2")) +
  theme_bw() +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = "none") +
  guides(fill = guide_legend(override.aes = list(fill = NA)),
         color = guide_legend(override.aes = list(linetype = 0, colour = c("#D55E00","#009E73","#0072B2")))) +
  ylab("Temperature (°C)")

```

```{r temp summary table}

temp_long %>% 
  group_by(reef) %>% 
  summarise(Mean = round(mean(temp, rm.na = TRUE), 1),
            SD = round(sd(temp), 2),
            Min = round(min(temp), 1),
            Max = round(max(temp), 1),
            N = n(),
            SE = round((SD / sqrt(N)), 10)) %>% 
  kable() %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```


```{r overall temp stat}

### Checking the linear model for overall temps:
temp_lm <- lm((temp) ~ reef, data = temp_long)
##check_model(temp_lm)
#check_heteroscedasticity(temp_lm) # no good
#check_normality(temp_lm) # no good
## transforming the data (log, sqrt, etc., does not improve the distribution of the residuals)


## Moving forward with Kruskal-Wallis test: non-parametric testing of distributions of samples
temp_kw <- kruskal.test(temp ~ reef, data = temp_long)
temp_pval <- substitute(italic(P[reef])==p, list(p = format(temp_kw[["p.value"]], digits = 2))) # save the p-value for plotting

### Pairwise comparisons of the reef environments using Dunn's Test for Multiple Comparisons with bonferroni p adjustment
temp_dt <- dunnTest(temp ~ reef, data = temp_long, method = "bonferroni")
temp_FN_pval <- substitute(italic(P[FR-NS])==p, list(p = format(temp_dt[["res"]][["P.adj"]][3], digits = 2))) # save the p-value for plotting
temp_NB_pval <- substitute(italic(P[NS-BR])==p, list(p = format(temp_dt[["res"]][["P.adj"]][2], digits = 2))) # save the p-value for plotting
temp_FB_pval <- substitute(italic(P[FR-BR])==p, list(p = format(temp_dt[["res"]][["P.adj"]][1], digits = 2))) # save the p-value for plotting

```


```{r overall temp plot with stats, fig.height=4, fig.width=4}

temp_stat_plot <- temp_plot +
  #annotate("text", x = 1, y = 24.8, label = deparse(temp_pval), parse = TRUE, size = 3) +
  annotate("text", x = 3.0, y = 33.4, label = deparse(temp_FN_pval), parse = TRUE, size = 3.5) +
  annotate("text", x = 3.02, y = 32.9, label = deparse(temp_FB_pval), parse = TRUE, size = 3.5) +
  annotate("text", x = 3.0, y = 32.4, label = deparse(temp_NB_pval), parse = TRUE, size = 3.5)
temp_stat_plot


#ggsave("Figures/Overall_temp.pdf", height = 4, width = 4, useDingbats = FALSE) # save plot

```

<br/>

### Mean temperatures

```{r temp df to xts}

## convert the temp data to xts for manipulation with apply.xxx
temp_xts <- xts(temp_wide[,-4], order.by = temp_wide[,4])

```

Means (monthly, weekly, daily)
```{r temp mean plots}

## Monthly Mean
monthly_mean <- data.frame(apply.monthly(temp_xts, colMeans, na.rm = TRUE)) %>% # monthly mean SST 
  rownames_to_column(var = "date") %>% 
  pivot_longer(-date, names_to = "reef", values_to = "mean_temp") %>% 
  mutate(reef = fct_relevel(reef, c("Nearshore", "Backreef", "Forereef")))

month_mean_plot <- ggplot(data = monthly_mean, aes(x = reef, y = mean_temp, fill = reef, colour = reef)) +
  labs(title = "Monthly Mean: Nov 2014 - Oct 2015",
              subtitle = "Temp collected every 30 min") +
  geom_half_violin(side = "r", alpha = 0.3, colour = NA) +
  geom_half_dotplot(side = "r", dotsize = 0.7) +
  #stat_summary(fun = "mean", size = 0.5, colour = "gray15") +
  scale_colour_manual(values = c("#D55E00","#009E73","#0072B2")) +
  scale_fill_manual(values = c("#D55E00","#009E73","#0072B2")) +
  theme_bw() +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = "none") +
  guides(fill = guide_legend(override.aes = list(fill = NA)),
         color = guide_legend(override.aes = list(linetype = 0, colour = c("#D55E00","#009E73","#0072B2")))) +
  ylab("Temperature (°C)")



## Weekly Mean
weekly_mean <- data.frame(apply.weekly(temp_xts, colMeans, na.rm = TRUE)) %>% # monthly mean SST 
  rownames_to_column(var = "date") %>% 
  pivot_longer(-date, names_to = "reef", values_to = "mean_temp") %>% 
  mutate(reef = fct_relevel(reef, c("Nearshore", "Backreef", "Forereef")))

week_mean_plot <- ggplot(data = weekly_mean, aes(x = reef, y = mean_temp, fill = reef, colour = reef)) +
  labs(title = "Weekly Mean: Nov 2014 - Oct 2015",
              subtitle = "Temp collected every 30 min") +
  geom_half_violin(side = "r", alpha = 0.3, colour = NA) +
  geom_half_dotplot(side = "r", dotsize = 0.7) +
  #stat_summary(fun = "mean", size = 0.5, colour = "gray15") +
  scale_colour_manual(values = c("#D55E00","#009E73","#0072B2")) +
  scale_fill_manual(values = c("#D55E00","#009E73","#0072B2")) +
  theme_bw() +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = "none") +
  guides(fill = guide_legend(override.aes = list(fill = NA)),
         color = guide_legend(override.aes = list(linetype = 0, colour = c("#D55E00","#009E73","#0072B2")))) +
  ylab("Temperature (°C)")



## Daily Mean
daily_mean <- data.frame(apply.daily(temp_xts, colMeans, na.rm = TRUE)) %>% # monthly mean SST 
  rownames_to_column(var = "date") %>% 
  pivot_longer(-date, names_to = "reef", values_to = "mean_temp") %>% 
  mutate(reef = fct_relevel(reef, c("Nearshore", "Backreef", "Forereef")))

day_mean_plot <- ggplot(data = daily_mean, aes(x = reef, y = mean_temp, fill = reef, colour = reef)) +
  labs(title = "Daily Mean: Nov 2014 - Oct 2015",
              subtitle = "Temp collected every 30 min") +
  geom_half_violin(side = "r", alpha = 0.3, colour = NA) +
  geom_half_dotplot(side = "r", dotsize = 0.3) +
  #stat_summary(fun = "mean", size = 0.5, colour = "gray15") +
  scale_colour_manual(values = c("#D55E00","#009E73","#0072B2")) +
  scale_fill_manual(values = c("#D55E00","#009E73","#0072B2")) +
  theme_bw() +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = "none") +
  guides(fill = guide_legend(override.aes = list(fill = NA)),
         color = guide_legend(override.aes = list(linetype = 0, colour = c("#D55E00","#009E73","#0072B2")))) +
  ylab("Temperature (°C)")

```


```{r stats of daily mean temps}

### Checking the linear model for daily mean temps:
day_mean_lm <- lm((mean_temp) ~ reef, data = daily_mean)
##check_model(day_mean_lm)
#check_heteroscedasticity(day_mean_lm) # no good
#check_normality(day_mean_lm) # no good
## transforming the data (log, sqrt, etc., improves the heteroscedasticity but not the distribution of the residuals)


## Moving forward with Kruskal-Wallis test: non-parametric testing of distributions of samples
day_mean_kw <- kruskal.test((mean_temp) ~ reef, data = daily_mean)
day_mean_pval <- substitute(italic(P[reef])==p, list(p = format(day_mean_kw[["p.value"]], digits = 2))) # save the p-value for plotting

### Pairwise comparisons of the reef environments using Dunn's Test for Multiple Comparisons with bonferroni p adjustment
day_mean_dt <- dunnTest(mean_temp ~ reef, data = daily_mean, method = "bonferroni")
day_mean_FN_pval <- substitute(italic(P[FR-NS])==p, list(p = format(day_mean_dt[["res"]][["P.adj"]][3], digits = 2))) # save the p-value for plotting
day_mean_NB_pval <- substitute(italic(P[NS-BR])==p, list(p = format(day_mean_dt[["res"]][["P.adj"]][2], digits = 2))) # save the p-value for plotting
day_mean_FB_pval <- substitute(italic(P[FR-BR])==p, list(p = format(day_mean_dt[["res"]][["P.adj"]][1], digits = 2))) # save the p-value for plotting


```

```{r stats of weekly mean temps}

### Checking the linear model for weekly mean temps:
week_mean_lm <- lm((mean_temp) ~ reef, data = weekly_mean)
##check_model(week_mean_lm)
#check_heteroscedasticity(week_mean_lm) # okay!
#check_normality(week_mean_lm) # no good
## transforming the data (log, sqrt, etc., does not improve the distribution of the residuals)


## Moving forward with Kruskal-Wallis test: non-parametric testing of distributions of samples
week_mean_kw <- kruskal.test(mean_temp ~ reef, data = weekly_mean)
week_mean_pval <- substitute(italic(P[reef])==p, list(p = format(week_mean_kw[["p.value"]], digits = 2))) # save the p-value for plotting

### Pairwise comparisons of the reef environments using Dunn's Test for Multiple Comparisons with bonferroni p adjustment
week_mean_dt <- dunnTest(mean_temp ~ reef, data = weekly_mean, method = "bonferroni")

```

```{r stats of monthly mean temps}

### Checking the linear model for monthly mean temps:
month_mean_lm <- lm((mean_temp) ~ reef, data = monthly_mean)
##check_model(month_mean_lm)
#check_heteroscedasticity(month_mean_lm) # okay!
#check_normality(month_mean_lm) # no good
## transforming the data (log, sqrt, etc., does not improve the distribution of the residuals)


## Moving forward with Kruskal-Wallis test: non-parametric testing of distributions of samples
month_mean_kw <- kruskal.test(mean_temp ~ reef, data = monthly_mean)
month_mean_pval <- substitute(italic(P[reef])==p, list(p = format(month_mean_kw[["p.value"]], digits = 2))) # save the p-value for plotting

### Pairwise comparisons of the reef environments using Dunn's Test for Multiple Comparisons with bonferroni p adjustment
month_mean_dt <- dunnTest(mean_temp ~ reef, data = monthly_mean, method = "bonferroni")

```


```{r full mean plots, fig.height=4, fig.width=12, message=FALSE, warning=FALSE}

## Add the stats:
month_mean_stat_plot <- month_mean_plot +
  annotate("text", x = 1, y = 26, label = deparse(month_mean_pval), parse = TRUE, size = 3)

week_mean_stat_plot <- week_mean_plot +
  annotate("text", x = 1, y = 26, label = deparse(week_mean_pval), parse = TRUE, size = 3)

day_mean_stat_plot <- day_mean_plot +
  annotate("text", x = 1, y = 25.5, label = deparse(day_mean_pval), parse = TRUE, size = 3) +
  annotate("text", x = 3.75, y = 32, label = deparse(day_mean_FN_pval), parse = TRUE, size = 2.5) +
  annotate("text", x = 3.83, y = 31.7, label = deparse(day_mean_FB_pval), parse = TRUE, size = 2.5) +
  annotate("text", x = 3.77, y = 31.4, label = deparse(day_mean_NB_pval), parse = TRUE, size = 2.5) +
  coord_cartesian(x = c(1, 3.7))


## Combine all mean plots together for visual comparison
ggarrange(month_mean_stat_plot, week_mean_stat_plot, day_mean_stat_plot, ncol = 3)
#ggsave("Figures/Mean_temp.pdf", height = 4, width = 12, useDingbats = FALSE) # save plot

```

<br/>

### Temperature ranges

Ranges (monthly, weekly, daily)
```{r temp range plots}

## a column range function to apply across time ranges below
colRange <- function(x) sapply(x, FUN = function(x) (max(x, na.rm = TRUE) - min(x, na.rm = TRUE)))


## Monthly Range
monthly_range <- data.frame(apply.monthly(temp_xts, colRange)) %>% # monthly mean SST 
  rownames_to_column(var = "date") %>% 
  pivot_longer(-date, names_to = "reef", values_to = "temp_range") %>% 
  mutate(reef = fct_relevel(reef, c("Nearshore", "Backreef", "Forereef")))

month_range_plot <- ggplot(data = monthly_range, aes(x = reef, y = temp_range, fill = reef, colour = reef)) +
  labs(title = "Monthly Range: Nov 2014 - Oct 2015",
       subtitle = "Temp collected every 30 min") +
  geom_half_violin(side = "r", alpha = 0.3, colour = NA) +
  geom_half_dotplot(side = "r", dotsize = 0.7) +
  #stat_summary(fun = "mean", size = 0.5, colour = "gray15") +
  scale_colour_manual(values = c("#D55E00","#009E73","#0072B2")) +
  scale_fill_manual(values = c("#D55E00","#009E73","#0072B2")) +
  theme_bw() +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = "none") +
  guides(fill = guide_legend(override.aes = list(fill = NA)),
         color = guide_legend(override.aes = list(linetype = 0, colour = c("#D55E00","#009E73","#0072B2")))) +
  ylab("Temperature (°C)")



## Weekly Range
weekly_range <- data.frame(apply.weekly(temp_xts, colRange)) %>% # monthly mean SST 
  rownames_to_column(var = "date") %>% 
  pivot_longer(-date, names_to = "reef", values_to = "temp_range") %>% 
  mutate(reef = fct_relevel(reef, c("Nearshore", "Backreef", "Forereef")))

week_range_plot <- ggplot(data = weekly_range, aes(x = reef, y = temp_range, fill = reef, colour = reef)) +
  labs(title = "Weekly Range: Nov 2014 - Oct 2015",
       subtitle = "Temp collected every 30 min") +
  geom_half_violin(side = "r", alpha = 0.3, colour = NA) +
  geom_half_dotplot(side = "r", dotsize = 0.7, binwidth = 1/5) +
  #stat_summary(fun = "mean", size = 0.5, colour = "gray15") +
  scale_colour_manual(values = c("#D55E00","#009E73","#0072B2")) +
  scale_fill_manual(values = c("#D55E00","#009E73","#0072B2")) +
  theme_bw() +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = "none") +
  guides(fill = guide_legend(override.aes = list(fill = NA)),
         color = guide_legend(override.aes = list(linetype = 0, colour = c("#D55E00","#009E73","#0072B2")))) +
  ylab("Temperature (°C)")



## Daily Range
daily_range <- data.frame(apply.daily(temp_xts, colRange)) %>% # monthly mean SST 
  rownames_to_column(var = "date") %>% 
  pivot_longer(-date, names_to = "reef", values_to = "temp_range") %>% 
  mutate(reef = fct_relevel(reef, c("Nearshore", "Backreef", "Forereef")))

day_range_plot <- ggplot(data = daily_range, aes(x = reef, y = temp_range, fill = reef, colour = reef)) +
  labs(title = "Daily Range: Nov 2014 - Oct 2015",
       subtitle = "Temp collected every 30 min") +
  geom_half_violin(side = "r", alpha = 0.3, colour = NA) +
  geom_half_dotplot(side = "r", dotsize = 0.3, binwidth = 1/10) +
  #stat_summary(fun = "mean", size = 0.5, colour = "gray15") +
  scale_colour_manual(values = c("#D55E00","#009E73","#0072B2")) +
  scale_fill_manual(values = c("#D55E00","#009E73","#0072B2")) +
  theme_bw() +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = "none") +
  guides(fill = guide_legend(override.aes = list(fill = NA)),
         color = guide_legend(override.aes = list(linetype = 0, colour = c("#D55E00","#009E73","#0072B2")))) +
  ylab("Temperature (°C)")

```


```{r stats of daily range temps}

### Checking the linear model for daily range temps:
day_range_lm <- lm((temp_range) ~ reef, data = daily_range)
##check_model(day_range_lm)
#check_heteroscedasticity(day_range_lm) # no good
#check_normality(day_range_lm) # no good
## transforming the data (log, sqrt, etc., improves the heteroscedasticity but not the distribution of the residuals)


## Moving forward with Kruskal-Wallis test: non-parametric testing of distributions of samples
day_range_kw <- kruskal.test(temp_range ~ reef, data = daily_range)
day_range_pval <- substitute(italic(P[reef])==p, list(p = format(day_range_kw[["p.value"]], digits = 2))) # save the p-value for plotting

### Pairwise comparisons of the reef environments using Dunn's Test for Multiple Comparisons with bonferroni p adjustment
day_range_dt <- dunnTest(temp_range ~ reef, data = daily_range, method = "bonferroni")
day_range_FN_pval <- substitute(italic(P[FR-NS])==p, list(p = format(day_range_dt[["res"]][["P.adj"]][3], digits = 2))) # save the p-value for plotting
day_range_NB_pval <- substitute(italic(P[NS-BR])==p, list(p = format(day_range_dt[["res"]][["P.adj"]][2], digits = 2))) # save the p-value for plotting
day_range_FB_pval <- substitute(italic(P[FR-BR])==p, list(p = format(day_range_dt[["res"]][["P.adj"]][1], digits = 2))) # save the p-value for plotting

```

```{r stats of weekly range temps}

### Checking the linear model for weekly range temps:
week_range_lm <- lm((temp_range) ~ reef, data = weekly_range)
##check_model(week_range_lm)
#check_heteroscedasticity(week_range_lm) # okay!
#check_normality(week_range_lm) # no good
## transforming the data (log, sqrt, etc., does not improve the distribution of the residuals)


## Moving forward with Kruskal-Wallis test: non-parametric testing of distributions of samples
week_range_kw <- kruskal.test(temp_range ~ reef, data = weekly_range)
week_range_pval <- substitute(italic(P[reef])==p, list(p = format(week_range_kw[["p.value"]], digits = 2))) # save the p-value for plotting

### Pairwise comparisons of the reef environments using Dunn's Test for Multiple Comparisons with bonferroni p adjustment
week_range_dt <- dunnTest(temp_range ~ reef, data = weekly_range, method = "bonferroni")
week_range_FN_pval <- substitute(italic(P[FR-NS])==p, list(p = format(week_range_dt[["res"]][["P.adj"]][3], digits = 2))) # save the p-value for plotting
week_range_NB_pval <- substitute(italic(P[NS-BR])==p, list(p = format(week_range_dt[["res"]][["P.adj"]][2], digits = 2))) # save the p-value for plotting
week_range_FB_pval <- substitute(italic(P[FR-BR])==p, list(p = format(week_range_dt[["res"]][["P.adj"]][1], digits = 2))) # save the p-value for plotting

```

```{r stats of monthly range temps}

### Checking the linear model for monthly range temps:
month_range_lm <- lm((temp_range) ~ reef, data = monthly_range)
##check_model(month_range_lm)
#check_heteroscedasticity(month_range_lm) # okay!
#check_normality(month_range_lm) # okay!
## data are good! But to keep consistent, I am moving forward with the same stat tests as other metrics


## Moving forward with Kruskal-Wallis test: non-parametric testing of distributions of samples
month_range_kw <- kruskal.test(temp_range ~ reef, data = monthly_range)
month_range_pval <- substitute(italic(P[reef])==p, list(p = format(month_range_kw[["p.value"]], digits = 2))) # save the p-value for plotting

### Pairwise comparisons of the reef environments using Dunn's Test for Multiple Comparisons with bonferroni p adjustment
month_range_dt <- dunnTest(temp_range ~ reef, data = monthly_range, method = "bonferroni")
month_range_FN_pval <- substitute(italic(P[FR-NS])==p, list(p = format(month_range_dt[["res"]][["P.adj"]][3], digits = 2))) # save the p-value for plotting
month_range_NB_pval <- substitute(italic(P[NS-BR])==p, list(p = format(month_range_dt[["res"]][["P.adj"]][2], digits = 2))) # save the p-value for plotting
month_range_FB_pval <- substitute(italic(P[FR-BR])==p, list(p = format(month_range_dt[["res"]][["P.adj"]][1], digits = 2))) # save the p-value for plotting

```


```{r full range plots, fig.height=4, fig.width=12, message=FALSE, warning=FALSE}

## Add the stats:
month_range_stat_plot <- month_range_plot +
  annotate("text", x = 0.95, y = 1.8, label = deparse(month_range_pval), parse = TRUE, size = 3) +
  annotate("text", x = 3.22, y = 5.2, label = deparse(month_range_FN_pval), parse = TRUE, size = 2.5) +
  annotate("text", x = 3.28, y = 5.6, label = deparse(month_range_NB_pval), parse = TRUE, size = 2.5) +
  annotate("text", x = 3.26, y = 5.4, label = deparse(month_range_FB_pval), parse = TRUE, size = 2.5)

week_range_stat_plot <- week_range_plot +
  #annotate("text", x = 0.95, y = 0.1, label = deparse(week_range_pval), parse = TRUE, size = 3) +
  annotate("text", x = 3.62, y = 5.4, label = deparse(week_range_FN_pval), parse = TRUE, size = 3.5) +
  annotate("text", x = 3.67, y = 6, label = deparse(week_range_NB_pval), parse = TRUE, size = 3.5) +
  annotate("text", x = 3.62, y = 5.7, label = deparse(week_range_FB_pval), parse = TRUE, size = 3.5) +
  coord_cartesian(x = c(1, 3.7))

day_range_stat_plot <- day_range_plot +
  annotate("text", x = 0.95, y = 0.1, label = deparse(day_range_pval), parse = TRUE, size = 3) +
  annotate("text", x = 3.9, y = 3.2, label = deparse(day_range_FN_pval), parse = TRUE, size = 2.5) +
  annotate("text", x = 3.97, y = 3.5, label = deparse(day_range_NB_pval), parse = TRUE, size = 2.5) +
  annotate("text", x = 3.93, y = 3.35, label = deparse(day_range_FB_pval), parse = TRUE, size = 2.5) +
  coord_cartesian(x = c(1, 4))


## Combine all range plots together for visual comparison
ggarrange(month_range_stat_plot, week_range_stat_plot, day_range_stat_plot, ncol = 3)
#ggsave("Figures/Range_temp.pdf", height = 4, width = 12, useDingbats = FALSE) # save plot

```


<br/>
<br/>


### Supplemental figure XX

```{r}

# Need to combine the other temperature plots here for a supplemental figure

```

<br/>
<br/>


## Colony survival {.tabset}

### Figure 2A

```{r survival dataframe setup, message=FALSE, warning=FALSE}

sur <- read.csv("Data/RT_survival.csv") %>% # Read in survival data (0 = living, 1 = mortality event under 'Status')
  mutate(Source = fct_relevel(Source, levels = c("NS", "BR", "FR")), # relevel source to be by distance from land
         Transplant = fct_relevel(Transplant, levels = c("NS", "BR", "FR"))) # relevel transplant to be by distance from land


sur$Colony <- as.factor(sur$Colony) # make colony ID a factor

sur.r <- Surv(sur$Days, sur$Status) # Creates your survival dataframe

# This produces the event data for each grouping (this case transplant) (% surviving at each Day and the CI with it)
sur.all <- survfit(sur.r ~ Source + Transplant, data = sur) # Computes an estimate of a survival curve based on transplantation using Kaplan-Meier; this will also be used for plotting
#sur.all # view output to see mortality event and sample size summary stats
#summary(sur.all)
  
```

<br/>

#### <span style="color: navy;">**Data Visualization**</span>

```{r survival figure, message=FALSE, warning=FALSE, fig.align='center', fig.width = 5.7, fig.height = 5.5}

surv_plot <- ggsurvplot(sur.all, data = sur,
           palette = c("#D55E00", "#0072B2", "#009E73", "#D55E00", "#0072B2", "#009E73", "#D55E00", "#0072B2", "#009E73"),
           linetype = c(1, 1, 1, 2, 2, 2, 3, 3, 3),
           censor = FALSE,
           legend.title = "",
           legend.labs = c("NS to NS", "NS to BR", "NS to FR", "BR to NS", "BR to BR", "BR to FR", "FR to NS", "FR to BR", "FR to FR")) 
surv_plot$plot <-  surv_plot$plot + scale_x_continuous(breaks = c(0, 365, 711, 1088, 1445), labels = c("2011", "2012", "2013", "2014", "2015")) +
  guides(col = guide_legend(ncol = 3)) +
  labs(x = "Time (years)", y = "Fraction surviving") +
  theme_bw() +
  theme(plot.margin = margin(0.1, 0.7, 0.1, 0.1, "cm"), panel.grid = element_blank(), legend.position = c(0.33, 0.13), text = element_text(size = 14)) +
  coord_cartesian(y = c(-0.02, 1.05), expand = FALSE)
  

fig2a <- surv_plot$plot
fig2a

## Save survival plots
# ggsave("Figures/Figure2A_Survival.pdf", width = 5.7, height = 5.5, useDingbats = FALSE) # save as PDF
# ggsave("Figures/Figure2A_Survival.png", width = 5.7, height = 5.5) # save as PNG

```

**Figure 2A.** Fraction of surviving *Siderastrea siderea* colonies through time (2011-2015) after reciprocal transplantation with respect to source location and transplanted location. Source location is represented by line type (FR = dashed; BR = solid; NS = dotted) and transplant location is denoted by color (<span style="color: #D55E00;">orange = NS [nearshore]</span>, <span style="color: #009E73;">green = BR [backreef]</span>, and <span style="color: #0072B2;">blue = FR [forereef]</span>). 

<br/>


### Supplementary Table 4

**Table S4.** Number or corals surviving per year in each transplant location (BR = backreef, FR = forereef, NS = Nearshore).

```{r}

tableS4 <- read.csv("Data/RT_survival_table.csv")[1:7] # Read in num corals surviving at each timepoint
names(tableS4) <- gsub(x = names(tableS4), pattern = "X", replacement = "") # remove 'X' from in front of years of columns

kable(tableS4) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```


### Statistical Exploration

##### While the current data are not able to be appropriately fit with statistical models, here are the models we explored:

<br/>

#### <span style="color: navy;">**Cox Proportional Hazard Model**</span>

```{r survival model, echo=TRUE, message=FALSE, warning=FALSE}

surv.mod <- coxph(sur.r ~ Transplant + Source, data = sur)

```

<br/>

Cox proportional hazard model output, with exp(coef) representing the hazard ratio, se(coef) is the standard error, z is the z score, and Pr(>|z|) is the propability that the estimated could be 0.

```{r survival model table, message=FALSE, warning=FALSE}

surv_mod_df <- data.frame(summary(surv.mod)$coefficients)
colnames(surv_mod_df) <- c("coefficient", "exp(coef)" , "se(coef)", "z", "Pr(>|z|)")

kable(surv_mod_df, digits = 2) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  column_spec(1, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```

<br/>

ANOVA output of the survival model.

```{r}

surv_aov <- anova(surv.mod,  test = 'Chisq')

kable(surv_aov, digits = 3) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  column_spec(1, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```

<br/>

###############################


## Calcification rate {.tabset}

<br/>


### Overall Calcification Statistics

```{r calc df setup, message=FALSE, warning=FALSE}

# read in dataframe
RT.calc <- read.csv('Data/RT_calcification.csv') # read in data

# convert dataframe from wide to long
RT.calc <- gather(RT.calc, TP, rate, y23:avg2)

# use function to remove any rows with missues values in the 'rate' column
RT.calc <- completeFun(RT.calc, "rate")

# subset for the average rate of corals that made it to the end 
RT.calc.fin <- subset(RT.calc, TP == "avg")
RT.calc.fin$rate <- as.numeric(RT.calc.fin$rate)

# subset for timepoint calcification rates (this dataframe is for the 'timepoint calcification' analysis)
RT.calc.tp <- subset(RT.calc, TP != "avg2")
RT.calc.tp <- subset(RT.calc.tp, TP != "avg")

# make TP and colony factors
RT.calc.tp$colony <- factor(RT.calc.tp$colony)
RT.calc.tp$TP <- factor(RT.calc.tp$TP)

```

#### <span style="color: navy;">**Model selection**</span>

**Overall calcification Akaike information criterion (AIC) model selection** Model selection for assessment of source and transplant location impacts on overall (2012 - 2015) coral calcification rates was performed using AIC. The model with the lowest AIC (in bold) best fit the data and was used for analyses.
```{r calcification AIC model selection, message=FALSE, warning=FALSE}

## AIC model selection
full.int <- lm(rate ~ source * trans, data = RT.calc.fin) # interaction of source with transplant location

# data look normal so I am okay with proceeding with a linear model here
##check_normality(full.int)
##check_model(full.int)

full.add <- lm(rate ~ source + trans, data = RT.calc.fin) # additive model of source with transplant location
tran.only <- lm(rate ~ trans, data = RT.calc.fin) # transplant location only
sourc.only <- lm(rate ~ source, data = RT.calc.fin) # source location only

## AIC table
calc.AIC <- AIC(full.int, full.add, tran.only, sourc.only) # create AIC comparison table

row.names(calc.AIC) <- c("Source * Transplant", "Source + Transplant", "Transplant only", "Source only") # rename the rows to reflect the model
calc.AIC$AIC <- round(calc.AIC$AIC, 2) # round the AIC values to 2 decimal places

kable(calc.AIC) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  row_spec(1, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times") 

```

<br/>

#### <span style="color: navy;">**Modelling Parametric Bootstrap 95% Confidence Intervals**</span>

Model:
```{r calcification model, echo = TRUE}

calc.model <- lm(rate ~ source * trans, data = RT.calc.fin) # selected model

```

```{r calcification bootstrap, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# NOTE: This is the code to run the parametric bootstrapping of the modeled calcification rates. It will NOT run when you knit the code. If you wish to run this portion of the code, either remove 'eval=FALSE' from codechunk. Bootstrapping code may take a long time to run, depending on model and dataframe size.

out <- simulate(calc.model, nsim = bootnum, seed = seed, re.form=NULL)
boots <- apply(out,2,function(x) predict(lm(x ~ source * trans, data = RT.calc.fin), reform = NA))
boots <- cbind(predict(calc.model, re.form=NA), boots)
RT.calc.fin2 <- (cbind(RT.calc.fin, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975))))))))
colnames(RT.calc.fin2)[6:8] <- c("estimate", "lowerci", "upperci")

write.csv(RT.calc.fin2, "Data/RT_calc_boot.csv")

```

<br/>

**Modeled Mean Calcification Rate and 95% Confidence Interval**

Parametric bootstrapped mean and 95% confidence intervals of calcification rates (mg cm^-2^ day^-1^) in response to transplant treatment (BR = backreef, FR = forereef, NS = Nearshore).
```{r CI table, message=FALSE, warning=FALSE}

RT.calc <- read.csv("Data/RT_calc_boot.csv", header = TRUE) # new dataframe with modeled 95% CI and mean calcification rates
RT.calc$trans <- factor(RT.calc$trans, levels = c("NS", "BR", "FR")) # relevel transplant factors
RT.calc$source <- factor(RT.calc$source, levels = c("NS", "BR", "FR")) # relevel source factors

RT.calc$Treatment <- paste(RT.calc$source, RT.calc$trans, sep = " to ") # make a 'treatment' column

# condensed dataframe of modeled mean and 95% CI per treatment
RT.calc.tab <- RT.calc %>% 
  group_by(Treatment) %>% 
  summarize(`Modeled Mean` = mean(estimate, na.rm=TRUE),
            `Lower 95% CI` = mean(lowerci, na.rm=TRUE),
            `Upper 95% CI` = mean(upperci, na.rm=TRUE))

kable(RT.calc.tab, digits = 2) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  column_spec(1, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```

### Figure 2B

```{r calcification plot, message=FALSE, warning=FALSE, fig.align='center', fig.height=4, fig.width=5}

fig2b <- ggplot(data = RT.calc, aes(x = trans, y = rate, colour = source)) +
  theme_bw() +
  theme(panel.grid = element_blank(), legend.key=element_blank(),  text = element_text(size = 13)) +
  geom_point(size = 2, position = position_jitterdodge(jitter.height = 0, dodge.width = 0.8, seed = 14)) +
  geom_linerange(aes(ymin = lowerci, ymax = upperci, colour = source), position = position_dodge(width = 0.7), size = 1.2, alpha = 0.2) +
  scale_color_manual("Source \nLocation", values=c("#D55E00", "#009E73", "#0072B2")) +
  xlab("Transplant Location") +
  ylab(bquote("Net Calcification (mg cm" ^-2~day^-1*")"))

fig2b

```

**Figure 2B.** Calcification rate (mg cm^–2^ day^–1^) averaged over the entire transplant experimental period (2012 – 2015) by transplant location. Source location is represented by color: <span style="color: #D55E00;">orange = NS (nearshore)</span>, <span style="color: #009E73;">green = BR (backreef)</span>, and <span style="color: #0072B2;">blue = FR (forereef)</span>. Colored bars represent modeled 95% confidence intervals with corresponding raw calcification rates per colony denoted by circles of the same color. 

<br/>


### Calcification by Year

#### <span style="color: navy;">**Model selection**</span>

**Year calcification Akaike information criterion (AIC) model selection**
  
Model selection for assessment of source and transplant location impacts on Year coral calcification rates was performed using AIC. The model in bold appropriately fit the data and was used for analyses.
```{r TP calcification AIC model selection, message=FALSE, warning=FALSE}

## AIC model selection
full.int <- lm(rate ~ source * trans * TP, data = RT.calc.tp) # fully interactive model

# data look normal so I am okay with proceeding with a linear model here
##check_normality(full.int)
##check_model(full.int)


full.add <- lm(rate ~ source + trans + TP, data = RT.calc.tp) # fully additive model
add.tp <- lm(rate ~ source * trans + TP, data = RT.calc.tp) # interaction of source with transplant location, add Year
add.trans <- lm(rate ~ source * TP + trans, data = RT.calc.tp) # interaction of source location with Year, add transplant location
add.source <- lm(rate ~ trans * TP + source, data = RT.calc.tp) # interaction of transplant with Year, add source location
tran.only <- lm(rate ~ trans, data = RT.calc.tp) # transplant location only
sourc.only <- lm(rate ~ source, data = RT.calc.tp) # source location only
tp.only <- lm(rate ~ TP, data = RT.calc.tp) # Year only

## AIC table
calc.tp.AIC <- AIC(full.int, full.add, add.tp, add.trans, add.source, tran.only, sourc.only, tp.only) # create AIC comparison table

row.names(calc.tp.AIC) <- c("Source * Transplant * Year", "Source + Transplant + Year", "Source * Transplant + Year", "Source * Year + Transplant", "Transplant * Year + Source", "Transplant only ", "Source only ", "Year only") # rename the rows to reflect the model
calc.tp.AIC$AIC <- round(calc.tp.AIC$AIC, 2) # round the AIC values to 2 decimal places

kable(calc.tp.AIC) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  row_spec(1, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times") 

```

<br/>

#### <span style="color: navy;">**Modelling Parametric Bootstrap 95% Confidence Intervals**</span>
  
Model:
```{r TP calcification model, echo = TRUE}

tp.model <- lm(rate ~ source * trans * TP, data = RT.calc.tp) # selected model

```

```{r TP calcification bootstrap, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# NOTE: This is the code to run the parametric bootstrapping of the modeled calcification rates. It will NOT run when you knit the code. If you wish to run this portion of the code, either remove 'eval=FALSE' from codechunk. Bootstrapping code may take a long time to run, depending on model and dataframe size.

out <- simulate(tp.model, nsim = bootnum, seed = seed, re.form=NULL)
boots <- apply(out,2,function(x) predict(lm(x ~ source * trans * TP, data = RT.calc.tp), reform = NA))
boots <- cbind(predict(tp.model, re.form=NA), boots)
RT.calc.tp2 <- (cbind(RT.calc.tp, as.data.frame(t(apply(boots, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975))))))))
colnames(RT.calc.tp2)[6:8] <- c("estimate", "lowerci", "upperci")

write.csv(RT.calc.tp2, "Data/RT_TP_calc_boot.csv")

```

<br/>

  
**Modeled Mean Calcification Rate and 95% Confidence Interval by Year**
  
Parametric bootstrapped mean and 95% confidence intervals of calcification rates (mg cm^-2^ day^-1^) in response to transplant treatment (BR = backreef, FR = forereef, NS = Nearshore) over time.
```{r TP CI table, message=FALSE, warning=FALSE}

RT.calc.tp <- read.csv("Data/RT_TP_calc_boot.csv", header = TRUE) # new dataframe with modeled 95% CI and mean calcification rates
RT.calc.tp$trans <- factor(RT.calc.tp$trans, levels = c("NS", "BR", "FR")) # relevel transplant location factors
RT.calc.tp$source <- factor(RT.calc.tp$source, levels = c("NS", "BR", "FR")) # relevel source location factors
RT.calc.tp$TP <- factor(RT.calc.tp$TP) # make Year a factor
levels(RT.calc.tp$TP) <- list("2013" = "y23", "2014" = "y34", "2015" = "y45")
RT.calc.tp$Treatment <- paste(RT.calc.tp$source, RT.calc.tp$trans, sep = " to ") # make a 'treatment' column
RT.calc.tp$Treatment <- paste(RT.calc.tp$Treatment, RT.calc.tp$TP, sep = " in ") # make a 'treatment' column

# condensed dataframe of modeled mean and 95% CI per treatment
RT.calc.TP.tab <- RT.calc.tp %>% 
  group_by(Treatment) %>% 
  summarize(`Modeled Mean` = mean(estimate, na.rm=TRUE),
            `Lower 95% CI` = mean(lowerci, na.rm=TRUE),
            `Upper 95% CI` = mean(upperci, na.rm=TRUE))

kable(RT.calc.TP.tab, digits = 2) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  column_spec(1, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```



#### <span style="color: navy;">**Data Visualization**</span>

```{r TP calcification plot, message=FALSE, warning=FALSE, fig.align='center', fig.height=4, fig.width=9.5}

calc.tp.plot <- ggplot(data = RT.calc.tp) +
  theme_bw() +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(), legend.key=element_blank(), legend.position = "none", strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1)) +
  geom_point(aes(x = TP, y = rate, colour = trans), size = 1.8, position = position_jitterdodge(jitter.height = 0, dodge.width = 0.5, seed = 14)) +
  geom_linerange(aes(x = TP, ymin = lowerci, ymax = upperci, colour = trans), position = position_dodge(width = 0.5), size = 1.2, alpha = 0.2) +
  facet_wrap(~ source) +
  scale_color_manual("Transplant Location", values=c("#D55E00", "#009E73", "#0072B2")) +
  xlab("Time (years)") +
  ylab(bquote("Net Calcification (mg cm" ^-2~day^-1*")"))

calc.tp.plot

```

**Figure 3B |** Calcification rate (mg cm^-2^ day^-1^) at yearly intervals over the entire transplant experimental period (2012 – 2015) by source location. Transplant location is represented by color: <span style="color: #D55E00;">red = NS (nearshore)</span>, <span style="color: #009E73;">green = BR (backreef)</span>, and <span style="color: #0072B2;">blue = FR (forereef)</span>. Colored bars represent modeled 95% confidence intervals with corresponding raw calcification rates per colony denoted by circles of the same color. 

<br/>


### Supplemental Tables

#### Supplemental Table 1

**Table S1.** Akaike information criterion (AIC) model selection for calcification linear models. Model selection for assessment of source and transplant location impacts on overall (2012 - 2015) and annual coral calcification rates performed using AIC. The model with the lowest AIC (in bold) best fit the data and was used for analyses.

```{r}

# combine both AIC tables
AIC_full <- rbind(calc.AIC, calc.tp.AIC)

kable(AIC_full) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  row_spec(1, bold = TRUE) %>% 
  row_spec(5, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times") %>% 
  pack_rows("Overall Calcification", 1, 4, italic = TRUE) %>%
  pack_rows("Annual Calcification", 5, 12, italic = TRUE)

```

<br/>


#### Supplemental Table 5

**Table S5** Linear model output assessing overall calcification responses. The intercept was set at corals from the backreef (BR) transplanted back to the backreef.

```{r}

tableS5 <- summary(calc.model)$coefficients

row.names(tableS5) <- c("(Intercept)", "source (FR)", "source (NS)", "transplant (FR)", "transplant (NS)", "source (FR):transplant (FR)", "source (NS):transplant (FR)", "source (FR):transplant (NS)", "source (NS):transplant (NS)")

kable(tableS5, digits = 2) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```

<br/>


#### Supplemental Table 6

**Table S6.** Modeled mean calcification rate and 95% confidence interval. Parametric bootstrapped mean and 95% confidence intervals of calcification rates (mg cm^-2^ day^-1^) in response to transplant treatment (BR = backreef, FR = forereef, NS = Nearshore).

```{r}

kable(RT.calc.tab, digits = 2) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  column_spec(1, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```

<br/>


#### Supplemental Table 7

**Table S6** Linear model output assessing annual calcification responses. The intercept was set at corals from the backreef (BR) transplanted back to the backreef from 2013.

```{r}

tableS7 <- summary(tp.model)$coefficients

row.names(tableS7) <- c("(Intercept)", "source (FR)", "source (NS)", "transplant (FR)", "transplant (NS)", "Year (2014)", "Year (2015)", "source (FR):transplant (FR)", "source (NS):transplant (FR)", "source (FR):transplant (NS)", "source (NS):transplant (NS)", "source (FR):Year (2014)", "source (NS):Year (2014)", "source (FR):Year (2015)", "source (NS):Year (2015)", "transplant (FR):Year (2014)", "transplant (NS):Year (2014)", "transplant (FR):Year (2015)", "transplant (NS):Year (2015)", "source (FR):transplant (FR):Year (2014)", "source (NS):transplant (FR):Year (2014)", "source (FR):transplant (NS):Year (2014)", "source (NS):transplant (NS):Year (2014)", "source (FR):transplant (FR):Year (2015)", "source (NS):transplant (FR):Year (2015)", "source (FR):transplant (NS):Year (2015)", "source (NS):transplant (NS):Year (2015)")


kable(tableS7, digits = 2) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```

<br/>


#### Supplemental Table 8

**Table S8.** Modeled mean calcification rate and 95% confidence interval by year. Parametric bootstrapped mean and 95% confidence intervals of calcification rates (mg cm^-2^ day^-1^) in response to transplant treatment (BR = backreef, FR = forereef, NS = Nearshore) over time.

```{r}

kable(RT.calc.TP.tab, digits = 2) %>% 
  kable_styling(position = "center", font_size = 14, full_width = FALSE) %>% 
  column_spec(1, bold = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Times")

```

<br/>


## GE Plasticity Tables {.tabset}

### Supplemental Table S3

*(These model outputs are taken from the plasticity analysis and just constructed into tables here)*

**Table S3.** Akaike information criterion (AIC) model selection for coral host and algal symbiont gene expression plasticity. Model selection for assessment of source and transplant location impacts on gene expression plasticity performed using AIC.

| Host Model          |     AIC |     BIC | Nagelkerke's R2 |
| :-------------------|--------:|--------:|----------------:|
| Source * Transplant |  46.845 |  64.687 |           0.833 |
| Source + Transplant | 102.088 | 112.794 |           0.146 |
| Transplant          |  99.632 | 106.769 |           0.108 |
| Source              | 102.398 | 109.535 |           0.034 |

| Symbiont Model      | AIC    | BIC     | Nagelkerke's R2 |
| :-------------------|-------:|--------:|----------------:|
| Source * Transplant | 31.742 | 46.714  |           0.863 |
| Source + Transplant | 94.949 | 104.930 |           0.038 |
| Transplant          | 91.827 | 98.481  |           0.011 |
| Source              | 91.317 | 97.971  |           0.027 |

<br/>


### Supplemental Table XX

*(These model outputs are taken from the plasticity analysis and just constructed into tables here)*

**Table SXX.** Linear model output assessing coral host gene expression plasticity. The intercept was set at corals from the backreef (BR) transplanted back to the backreef.

|                             | Estimate | Std. Error | t value |     Pr(>t) |
| :---------------------------|---------:|-----------:|--------:|:-------------|
| *(Intercept) *              |  -0.6692 |     0.1731 |  -3.866 | 0.000460 *** |
| Source (FR)                 |   1.1464 |     0.2448 |   4.683 | 4.17e-05 *** |
| Source (NS)                 |   0.6369 |     0.2568 |   2.481 | 0.018072 *   |
| Transplant (FR)             |   1.1503 |     0.2448 |   4.699 | 3.97e-05 *** |
| Transplant (NS)             |   0.0778 |     0.2998 |   0.259 | 0.796787     |
| Source (FR):Transplant (FR) |  -3.0430 |     0.3462 |  -8.789 | 2.22e-10 *** |
| Source (NS):Transplant (FR) |  -0.2569 |     0.3548 |  -0.724 | 0.473857     |
| Source (FR):Transplant (NS) |   0.1188 |     0.4580 |   0.259 | 0.796844     |
| Source (NS):Transplant (NS) |  -1.5480 |     0.4133 |  -3.746 | 0.000647 *** |

<br/>


### Supplemental Table XX

*(These model outputs are taken from the plasticity analysis and just constructed into tables here)*

**Table SXX.** Linear model output assessing algal symbiont gene expression plasticity. The intercept was set at corals from the backreef (BR) transplanted back to the backreef.

|                             | Estimate | Std. Error | t value |     Pr(>t) |
| :---------------------------|---------:|-----------:|--------:|:-------------|
| *(Intercept) *              |  -1.2588 |     0.1355 |  -9.290 | 1.80e-10 *** |
| Source (FR)                 |   1.7762 |     0.1916 |   9.270 | 1.90e-10 *** |
| Source (NS)                 |   1.5797 |     0.2142 |   7.374 | 2.66e-08 *** |
| Transplant (FR)             |   1.5676 |     0.1916 |   8.181 | 3.06e-09 *** |
| Transplant (NS)             |   2.0990 |     0.2347 |   8.944 | 4.29e-10 *** |
| Source (FR):Transplant (FR) |  -2.9321 |     0.2710 | -10.820 | 4.72e-12 *** |
| Source (NS):Transplant (FR) |  -1.0877 |     0.3030 |  -3.590 |  0.00112 **  |
| Source (FR):Transplant (NS) |     *NA* |       *NA* |    *NA* |       *NA*   |
| Source (NS):Transplant (NS) |  -3.0780 |     0.3319 |  -9.274 | 1.88e-10 *** |




<br/>


## Final figures {.tabset}

### Figure 1

```{r read in map for fig 1a}

## Read in the map of sites (this was created by KD Castillo in ArcGIS and saved as a PNG)
map_png <- readPNG("Figures/Figure1A_Map.png")

# make the map png into a ggplot object
fig_1a <- ggplot() + 
  background_image(map_png) + 
  theme_void()

```

```{r fig 1b}

fig_1b <- temp_stat_plot +
  theme(text = element_text(size = 15))

```

```{r fig 1c}

fig_1c <- week_range_stat_plot + 
  theme(plot.subtitle = element_blank(), plot.title = element_blank(), text = element_text(size = 15)) +
  ylab("Weekly Temperature Range (°C)")

```

```{r full figure 1, fig.height = 4, fig.width = 13}

ggarrange(fig_1a, fig_1b, fig_1c, ncol = 3, labels = "AUTO")
ggsave("Figures/Figure1_map_temp.pdf", height = 4, width = 13, useDingbats = FALSE) # save plot as PDF
ggsave("Figures/Figure1_map_temp.png", height = 4, width = 13) # save plot as PNG

```
**Figure 1:** Map of reef environments on the southern Belize Mesoamerican Barrier Reef System with *in situ* seawater temperatures recorded at these locations. (**A**) Model showing locations of forereef (FR; blue), backreef (BR; green), and nearshore (NS; orange) environments. Forereef and backreef sites are ~2-km apart on the seaward and landward sides of the Barrier Reef’s crest, respectively. The nearshore site is located 30-km west toward mainland Belize. (**B**) Mean (±1 SD) and distribution of *in situ* seawater temperatures taken every 30 minutes at forereef (blue), backreef (green), and nearshore (orange) environments from November 2014 to November 2015. (**C**) Weekly temperature ranges across the three reef environments demonstrating differences in temperature variability across sites.

<br/>
<br/>


### Figure 2

```{r figure 2, fig.width = 11, fig.height = 5}

ggarrange(fig2a, fig2b, ncol = 2, labels = "AUTO", widths = c(1, 0.8))

## Save survival plots
ggsave("Figures/Figure2_survival_calc.pdf", width = 11, height = 5, useDingbats = FALSE) # save as PDF
ggsave("Figures/Figure2_survival_calc.png", width = 11, height = 5) # save as PNG

```

<br/>
<br/>

## Supplemental Figures {.tabset}

### Figure S1

```{r figure S1, fig.height = 8, fig.width = 14}

fig_s2a <- raw_temp_plot + 
  theme(text = element_text(size = 15))

fig_s2b <- month_mean_stat_plot + 
  theme(plot.subtitle = element_blank(), plot.title = element_blank(), text = element_text(size = 15)) +
  ylab("Monthly Temperature Mean (°C)")

fig_s2c <- week_mean_stat_plot + 
  theme(plot.subtitle = element_blank(), plot.title = element_blank(), text = element_text(size = 15)) +
  ylab("Weekly Temperature Mean (°C)")

fig_s2d <- day_mean_stat_plot + 
  theme(plot.subtitle = element_blank(), plot.title = element_blank(), text = element_text(size = 15)) +
  ylab("Daily Temperature Mean (°C)")


fig_s2e <- month_range_stat_plot + 
  theme(plot.subtitle = element_blank(), plot.title = element_blank(), text = element_text(size = 15)) +
  ylab("Monthly Temperature Range (°C)")

fig_s2f <- day_range_stat_plot + 
  theme(plot.subtitle = element_blank(), plot.title = element_blank(), text = element_text(size = 15)) +
  ylab("Daily Temperature Range (°C)")




ggarrange(fig_s2a, fig_s2b, fig_s2c, fig_s2d, fig_s2e, fig_s2f, ncol = 3, nrow = 2, labels = "AUTO")
ggsave("Figures/Supplement_Figures/FigureS1_temps.pdf", height = 8, width = 14, useDingbats = FALSE) # save plot
ggsave("Figures/Supplement_Figures/FigureS1_temps.png", height = 8, width = 14) # save plot

```
**Figure S1**. *In situ* temperatures recorded every 30 minutes from November 2014 to October 2015 on the nearshore (NS; orange), backreef (BR; green), and forereef (FR; blue) habitats assessed during this reciprocal transplant experiment on the Belize MBRS. (*A*) Raw temperature observations showing overall temperature patterns through the sampling period at each site. (*B*) Monthly, (*C*) Weekly, and (*D*) daily mean temperature comparisons across the three reef environments. (*E*) Monthly and (*F*) daily temperature ranges across the three reef environments demonstrating differences in temperature variability across sites.

<br/>
<br/>


### Figure S2

```{r figure s2a, message=FALSE, warning=FALSE, fig.align='center', fig.height=4, fig.width=9.5}

figS2a <- ggplot(data = RT.calc.tp) +
  theme_bw() +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(), legend.key=element_blank(), legend.position = "none", strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1)) +
  geom_point(aes(x = TP, y = rate, colour = trans), size = 1.8, position = position_jitterdodge(jitter.height = 0, dodge.width = 0.5, seed = 14)) +
  geom_linerange(aes(x = TP, ymin = lowerci, ymax = upperci, colour = trans), position = position_dodge(width = 0.5), size = 1.2, alpha = 0.2) +
  facet_wrap(~source) +
  scale_color_manual("Transplant Location", values=c("#D55E00", "#009E73", "#0072B2")) +
  xlab("Time (years)") +
  ylab(bquote("Net Calcification (mg cm" ^-2~day^-1*")"))

```

```{r figure S2b, message=FALSE, warning=FALSE, fig.align='center', fig.height=4, fig.width=5}

figS2b <- ggplot(data = RT.calc, aes(x = source, y = rate, colour = trans)) +
  theme_bw() +
  theme(panel.grid = element_blank(), legend.key=element_blank()) +
  geom_point(size = 2, position = position_jitterdodge(jitter.height = 0, dodge.width = 0.8, seed = 14)) +
  geom_linerange(aes(x = source, ymin = lowerci, ymax = upperci, colour = trans), position = position_dodge(width = 0.7), size = 1.2, alpha = 0.2) +
  scale_color_manual("Transplant \nLocation", values=c("#D55E00", "#009E73", "#0072B2")) +
  xlab("Source Location") +
  ylab(bquote("Net Calcification (mg cm" ^-2~day^-1*")"))

```

```{r figure s2b, message=FALSE, warning=FALSE, fig.align='center', fig.height=4, fig.width=9.5}

figS2c <- ggplot(data = RT.calc.tp) +
  theme_bw() +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.background=element_blank(), legend.key=element_blank(), strip.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=1)) +
  geom_point(aes(x = TP, y = rate, colour = source), size = 1.8, position = position_jitterdodge(jitter.height = 0, dodge.width = 0.5, seed = 14)) +
  geom_linerange(aes(x = TP, ymin = lowerci, ymax = upperci, colour = source), position = position_dodge(width = 0.5), size = 1.2, alpha = 0.2) +
  facet_wrap(~ trans) +
  scale_color_manual("Source \nLocation", values=c("#D55E00", "#009E73", "#0072B2")) +
  xlab("Time (years)") +
  ylab(bquote("Net Calcification (mg cm" ^-2~day^-1*")"))

```

```{r figure s2 legends}

library(cowplot)
library(gridExtra) 
library(grid)

### Transplant colour legend
figS2a_legend <- as_ggplot(get_legend(figS2b))
# then need to remove legend from fig 2Sb
figS2b <- figS2b + theme(legend.position = "none")

### Source colour legend
figS2c_legend <- as_ggplot(get_legend(figS2c))
# then need to remove legend from fig 2Sc
figS2c <- figS2c + theme(legend.position = "none")

```

```{r message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}

plot_grid(figS2a, figS2a_legend, figS2b, figS2c, figS2c_legend, rel_widths = c(1.3, 0.1, 0.7), labels = c("A", "", "B", "C", ""), scale = 0.85) +
  draw_label("Source Location", size = 11, x = 0.33, y = 0.96) +
  draw_label("Transplant Location", size = 11, x = 0.33, y = 0.46)
ggsave("Figures/Supplement_Figures/FigureS2_Calcification.pdf", height = 6, width = 12, useDingbats = FALSE)
ggsave("Figures/Supplement_Figures/FigureS2_Calcification.png", height = 6, width = 12)

```
**Supplemental Figure 2.** Calcification rate (mg cm^–2^ day^–1^) coloured by either (**A-B**) transplant or (**C**) source location (orange = NS [nearshore], green = BR [backreef], and blue = FR [forereef]), at (**A, C**) yearly intervals or (**B**) averaged over the entire transplant experimental period. Colored bars represent modeled 95% confidence intervals with corresponding raw calcification rates per colony denoted by circles of the same color.

<br/>
<br/>


## <span style="color: navy;">*Session Information:*</span>
*Last run on `r format(Sys.time(), '%d %B %Y')`*
```{r echo=FALSE}

sessionInfo()

```

